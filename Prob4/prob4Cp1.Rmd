---
title: "Problema 4 - Checkpoint 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(GGally)
library(dplyr)
library(Hmisc)
library(resample)

avaliacoes <- read.csv("ml-latest-small/ratings.csv")

```
## Análise de filmes

Para o checkpoint 1 do problema 4, nossa base de dados é referente a análise de filmes. Cada filme possui 0 ou mais caegorias, além de avaliações que variam de 1 a 5, em intervalos de 0,5. 

### Parte 1

A primeira parte é destinada para avaliar uma trilogia e idenfificar qual dos episódios há melhor avaliação e para qual há mais variação nas notas atribuídas ao filme.

A trilogia escolhida, composta de 3 filmes, foi Jurassic Park. No gráfico abaixo podemos ver como estão distribuídas as avaliações para cada filme.

```{r}
jp_movies <- c(480, 1544, 4638)
jp_names <- c("Jurassic Park", "The Lost World: Jurassic Park", "Jurassic Park III")

jp <- subset(avaliacoes, avaliacoes$movieId == jp_movies[1] | avaliacoes$movieId == jp_movies[2] | avaliacoes$movieId == jp_movies[3])

jp["nome"] <- NA
for(i in 1:3){
  jp$nome[jp$movieId == jp_movies[i]] <- jp_names[i]
}

ggplot(jp, aes(rating)) + geom_histogram(binwidth = 0.5) + facet_grid(. ~
    nome, scales = "free", space = "free")
```

```{r}
df <- data.frame()

for(i in jp_movies){
  b = bootstrap(subset(jp, movieId==i) , median(rating))
  median.jp = CI.percentile(b, probs = c(.025, .975))
  df <- data.frame(rbind(df, data.frame(median.jp)))
}

df$nome = c(jp_names[1], jp_names[2], jp_names[3])

df %>% 
  ggplot(aes(x = nome, ymin = X2.5., ymax = X97.5.)) + 
  geom_errorbar(width = .2)
```


```{r}
ggplot(jp1, aes(x = movieId, y = rating)) + 
  stat_summary(fun.y = mean, geom = "point") + 
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.2)
```


``` {r, message=FALSE, warning=FALSE}

movie.genre <- read.csv("movie-genre.csv")
genre.median <- data.frame(movieId=numeric(0), n=numeric(0), mediana=numeric(0))


for(id in 1:149532){
  #se existir filme com id n
  if(nrow( subset(movie.genre, movieId == id) ) > 0){
    
    id <- as.numeric(id)
    avaliacoes1 <- subset(avaliacoes, movieId == id)
    #se esse filme possui avaliacoes
    if(nrow(avaliacoes1) > 0){
      
      # se filme possui um gênero e é no genre
      if(length(movie.genre$genre[movie.genre$movieId==id]) == 1 & movie.genre$genre[movie.genre$movieId==id]  == "(no genres listed)"){
        v.n <- 0
      }
      else{
          # n é quantidade de gêneros
          v.n <- as.numeric(sum(movie.genre$movieId == id))
      }
      # calcula mediana de avaliaçÕes do filme
      v.mediana <- median(avaliacoes1$rating)
      # adiciona na tabela
      genre.median <- rbind(genre.median, data.frame(movieId = id, n = v.n, mediana = v.mediana))
    }
  }
}

g1 <- subset(genre.median, genre.median$n == 1)
g2 <- subset(genre.median, genre.median$n == 2)
g3 <- subset(genre.median, genre.median$n == 3)
g4 <- subset(genre.median, genre.median$n == 4)
g5 <- subset(genre.median, genre.median$n == 5)
g6 <- subset(genre.median, genre.median$n == 6)

```

```{r}
b = bootstrap(g1, median(mediana))
median.g1 = CI.percentile(b, probs = c(.025, .975))
median.g1

b = bootstrap(g2, median(mediana))
median.g2 = CI.percentile(b, probs = c(.025, .975))
median.g2

b = bootstrap(g3, median(mediana))
median.g3 = CI.percentile(b, probs = c(.025, .975))
median.g3

b = bootstrap(g4, median(mediana))
median.g4 = CI.percentile(b, probs = c(.025, .975))
median.g4

b = bootstrap(g5, median(mediana))
median.g5 = CI.percentile(b, probs = c(.025, .975))
median.g5

b = bootstrap(g6, median(mediana))
median.g6 = CI.percentile(b, probs = c(.025, .975))
median.g6


df = data.frame(rbind(median.g1, median.g2, median.g3, median.g4, median.g5, median.g6))
df$medida = row.names(df)

df %>% 
  ggplot(aes(x = medida, ymin = X2.5., ymax = X97.5.)) + 
  geom_errorbar(width = .2)
```